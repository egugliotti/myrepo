---
title: "FY18 & FY19 Cost Reporting"
output: html_document
---
#### Click the arrow by the line office name to view all systems belonging to that office. The table can be filtered by line office and cost. Additionally the columns can be expanded by hovering mouse over the place where the column appears to end. 

### FY18
```{r setup, include=FALSE}
library(plyr)
library(readr)
library(dplyr)
library(tidyverse)
library(sjmisc)
library(stringr)

myfiles = list.files(path="/Users/elizabethgugliotti/Desktop/EORES v1.6 Files (PROD-NOSIA-II)", pattern="*.csv", full.names=TRUE)

ElementsMeasureParameters<-read.csv(myfiles[2])
GroupstoSource<-read.csv(myfiles[3])
IsContributingMember<-read.csv(myfiles[4])
IsContributingMember<- IsContributingMember[-1,]
IsContributingMember$surveyed_product_elicitation_id<-as.integer(IsContributingMember$surveyed_product_elicitation_id)
IsDirectContributer<-read.csv(myfiles[5])
NetworkConsistsOfSystem<-read.csv(myfiles[6])
PlatformHasSensingElements<-read.csv(myfiles[7])
POCtoProd<-read.csv(myfiles[8])               
POCtoReq<-read.csv(myfiles[9])               
POCtoSystem<-read.csv(myfiles[10])               
POCtoVT<-read.csv(myfiles[11])                  
POHtoReq<-read.csv(myfiles[12])                  
POHtoSystem<-read.csv(myfiles[13])              
ProductToTree<-read.csv(myfiles[14])             
ReqtoVT<-read.csv(myfiles[15])                   
SystemHasPlatform<-read.csv(myfiles[16])         
DataSource<-read.csv(myfiles[17])                
Elements<-read.csv(myfiles[18])                  
Networks<-read.csv(myfiles[20])  
ObservingSystemCostInformation<-read.csv(myfiles[21])
Parameters<-read.csv(myfiles[23])                
Person<-read.csv(myfiles[24])                    
Platforms<-read.csv(myfiles[25])                 
POH<-read.csv(myfiles[26])
Requirements<-read.csv(myfiles[28])              
SourceGroups<-read.csv(myfiles[29])  
Systems<-read.csv(myfiles[30])                   
VTraw<-read.csv(myfiles[37])
```


```{r connections, echo = FALSE}
system2cost_2018<- Systems %>%
  full_join(ObservingSystemCostInformation, by="system_id")%>%
  select(-country_names, -system_deployment_plans, -system_description, -system_cost_id, -palma_id) %>%
  filter(year == 2018) %>%
  arrange(desc(osc_baseline_observing_system_category), desc(cost_type)) %>%
  full_join(POHtoSystem[POHtoSystem$poh_affiliation_type=="OBSERVING SYSTEM OWNER",], by = "system_id") %>%
  filter(level_3_short_name == "NOAA") %>%
  filter(!is.na(system_name)) %>%
  filter(osc_baseline_observing_system_category == "Critical") %>%
  select(-system_id, -system_intended_use) %>%
  select(1:12, level_4_short_name)  %>%
  arrange(level_4_short_name,cost_category, desc(cost)) %>%
  select(level_4_short_name,everything()) %>%
  mutate(system_name = paste0(system_name," (",system_acronym,")")) %>%
  select(-cost_units, - system_acronym, -year_type) %>%
  filter(cost_category == "Annual Operating Cost")
```

```{r, echo = FALSE, warning = FALSE}
# install.packages("reactable")
library(reactable)
reactable(system2cost_2018, searchable = TRUE, resizable = TRUE, groupBy = "level_4_short_name",
          columns = list(
            level_4_short_name = colDef(name = "Line Office", sortable = TRUE),
            system_name = colDef(name = "System Name", minWidth = 300),
            system_type = colDef(name = "System Type"),
            system_life_cycle_phase = colDef(name = "System Life Cycle Phase"),
            osc_baseline_observing_system_category = colDef(name = "OSC Baseline Observing System Category", minWidth = 200),
            year = colDef(name = "Fiscal Year"),
            cost_source = colDef(name = "Cost Source"),
            cost_type = colDef(name = "Cost Type"),
            cost_category = colDef(name = "Cost Category"),
            cost = colDef(name = "Cost ($K)", sortable = TRUE)
          ),
          theme = reactableTheme(
            style = list(fontFamily = "Work Sans, sans-serif")
          ))
```



### FY19
#### Systems that we do have FY19 Cost information for
```{r, echo = FALSE}
system2cost_2019<- Systems %>%
  full_join(ObservingSystemCostInformation, by="system_id")%>%
  select(-country_names, -system_deployment_plans, -system_description, -system_cost_id, -palma_id) %>%
  filter(year == 2019) %>%
  arrange(desc(osc_baseline_observing_system_category), desc(cost_type)) %>%
  full_join(POHtoSystem[POHtoSystem$poh_affiliation_type=="OBSERVING SYSTEM OWNER",], by = "system_id") %>%
  filter(level_3_short_name == "NOAA") %>%
  filter(!is.na(system_name)) %>%
  filter(osc_baseline_observing_system_category == "Critical") %>%
  select(-system_intended_use) %>%
  select(1:12, level_4_short_name)  %>%
  mutate(system_name = paste0(system_name," (",system_acronym,")")) %>%
  select(-system_acronym,-year_type, -cost_units, - system_id)

# POCtoSystem_Cost<- POCtoSystem %>%
#  filter(poc_type == "COST") %>%
#  select(-poc_phone_extension, -poc_phone_number, -poc_title, -poc_type) %>%
#  mutate(poc_name = paste0(poc_first_name," ",poc_last_name)) %>%
#  select(-poc_first_name, -poc_last_name)

# poc_by_system<- POCtoSystem_Cost %>%
#  group_by(system_id) %>%
#  summarise(poc_count = length(unique(poc_name))) %>%
#  as.data.frame() %>%
#  mutate(poc_index = seq(1, poc_count)) %>%
#  View()

# system2cost_2019 <- system2cost_2019 %>%
#  inner_join(POCtoSystem_Cost, by = "system_id") %>%
#  select(-system_id, -system_poc_id) %>%
#gather()
  

reactable(system2cost_2019, searchable = TRUE, resizable = TRUE, groupBy = c("level_4_short_name", "system_name"),
          columns = list(
            level_4_short_name = colDef(name = "Line Office", sortable = TRUE),
            system_name = colDef(name = "System Name", minWidth = 300),
            osc_baseline_observing_system_category = colDef(name = "OSC Baseline Observing System Category", minWidth = 200),
            system_type = colDef(name = "System Type"),
            system_life_cycle_phase = colDef(name = "System Life Cycle Phase"),
            year = colDef(name = "Fiscal Year"),
            cost_type = colDef(name = "Cost Type"),
            cost_category = colDef(name = "Cost Category"),
            cost = colDef(name = "Cost ($K)", sortable = TRUE, aggregate = "max")),
          theme = reactableTheme(
            style = list(fontFamily = "Work Sans, sans-serif")
          ))
```
S-NPP cost information not provided for FY19


#### Systems that we do not have FY19 cost information for
```{r, echo = FALSE}
# Systems that we don't have cost for in 2019
system2cost_not2019<- Systems %>%
  full_join(ObservingSystemCostInformation, by="system_id")%>%
  select(-country_names, -system_deployment_plans, -system_description, -system_cost_id, -palma_id) %>%
  filter(osc_baseline_observing_system_category == "Critical") %>%
  arrange(desc(osc_baseline_observing_system_category), desc(cost_type)) %>%
  full_join(POHtoSystem[POHtoSystem$poh_affiliation_type=="OBSERVING SYSTEM OWNER",], by = "system_id") %>%
  filter(level_3_short_name == "NOAA") %>%
  filter(!is.na(system_name)) %>%
  filter(system_life_cycle_phase == "Operational") %>%
  select(-system_id, -system_intended_use) %>%
  select(1:12, level_4_short_name) %>%
  mutate(system_name = paste0(system_name," (",system_acronym,")")) %>%
  distinct(system_name, .keep_all = TRUE) %>%
  filter(!system_name %in% c("Ionosonde (Ionosonde)",
                          "Global Tropical Moored Buoy Array (GTMBA)",
                          "GOS Regional Basic Surface Synoptic Network (GOS Surface)",
                          "GOS Upper Air Network (GOS Upper Air)","GCOS Reference Upper Air Network (GRUAN)",
                          "Global Energy and Water Cycle Experiment (GEWEX)",
                          "Spotter/Skywarn Volunteer Program (Spotter)",
                          "Advanced Composition Explorer (ACE)",
                          "Ecosystems Surveys (Ecosystems Surveys)",
                          "Fishery Independent Surveys (Fish Surveys)", 
                          "Marine Recreational Information Program (MRIP)",
                          "Protected Resources Surveys (PR Surveys)", 
                          "Habitat Assessment (Hab Surveys)", 
                          "Habitat Assessment (Hab Surveys)", 
                          "Commercial Fisheries Dependent Data Surveys (NMFS CFD)",
                          "Ocean Noise Reference Station Network (NRS)",
                          "Chesapeake Bay Interpretive Buoy System (CBIBS)",
                          "Economic and Socio-cultural Data Surveys (Econ and Socio Surveys)",
                          "Constellation Observing System for Meteorology, Ionosphere, and Climate (COSMIC-1/FORMOSAT-3)",
                          "International Arctic Buoy Programme (IABP)",
                          "Suomi National Polar-Orbiting Partnership Satellite (S-NPP)"))

system2cost_not2019$reported_in_2019<- system2cost_not2019$system_name %in% system2cost_2019$system_name


system2cost_not2019<- system2cost_not2019 %>%
  distinct(system_name, .keep_all = TRUE) %>%
  filter(reported_in_2019 == FALSE) %>%
  select(-system_acronym, -year_type, -cost_type, -cost, -cost_category, -cost_source, -year, -cost_units, -reported_in_2019)

reactable(system2cost_not2019, searchable = TRUE, resizable = TRUE, groupBy = "level_4_short_name",
          columns = list(
            level_4_short_name = colDef(name = "Line Office", sortable = TRUE),
            system_name = colDef(name = "System Name", minWidth = 300),
            osc_baseline_observing_system_category = colDef(name = "OSC Baseline Observing System Category", minWidth = 200),
            system_type = colDef(name = "System Type"),
            system_life_cycle_phase = colDef(name = "System Life Cycle Phase")),
          theme = reactableTheme(
            style = list(fontFamily = "Work Sans, sans-serif")
          ))
```

